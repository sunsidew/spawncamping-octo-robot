<!DOCTYPE html>
<html>
<head>
  <title>Arbos</title>
  <%= stylesheet_link_tag    "application", media: "all" %>
  <%= javascript_include_tag "application" %>
  <%= csrf_meta_tags %>
</head>
	

<body style="background-color: #ECF0F1;">

	<%= render 'layouts/header' %>
	<div class="container-fluid">
		<%= yield %>
	</div>

</body>

<script type="text/javascript" charset="utf-8">

  var STICKIES = function () {

    $.global_var = {
            boardtop: 112,
            boardleft: 20,
            boardheight: 600,
            boardwidth: 1011
        };

    var initStickies = function initStickies() {

      $('#board').append($('<div />', {
        text: "+",
        class: "add-sticky",
        click: function() { 
          showStickies();  
          $(this).remove();
        }
      }));
    };

    var showStickies = function showStickies() {

      $('#board').append($("<div />", {
        class: "sticky-box"
      })
        .append($("<div />", { 
          text: "Y", 
          class: "add-sticky",
          click: function () { 
            createSticky({ id: +new Date(), top: "200px", left: "100px", text: "", type: "yellow_sticky" }); 
            initStickies();
            $(this).parent().remove();
          }
        }))
        .append($("<div />", { 
          text: "B", 
          class: "add-sticky",
          click: function () { 
            createSticky({ id: +new Date(), top: "200px", left: "100px", text: "", type: "blue_sticky"}); 
            initStickies();
            $(this).parent().remove();
          }
        }))
        .append($("<form>", {
          class : "form-search"
        })
          .append($("<input />", {
            type: "text",
            placeholder: "동영상 임베드 코드 입력해주세요",
            class: "input-large search-query",
            id: "mv_embedcode"
          }))
          .append($("<button />", {
            type: "button",
            text: "M",
            class: "btn btn-success",
            click: function () { 
              createSticky({ id: +new Date(), top: "200px", left: "100px", text: mv_embedcode.value, type: "mv_sticky"}); 
              initStickies();
              $(this).parent().parent().remove();
            }
          }))
        )
      );
    };

    var openStickies = function openStickies() {
      
      initStickies();

      <% @posts.each do |post| %>
        createSticky({id: '<%= post.id %>', top: '<%= post.top.to_s+"px" %>', left: '<%= post.left.to_s+"px" %>', text: '<%= post.story.html_safe %>', type: '<%= post.type %>'});
      <% end %>
    };

    var moveSticky = function moveSticky(id) {
      if (confirm("이동시키겠습니까?"))
      {
        $.post('<%= post_move_location_board_path(@board) %>', { post_id: id })
          .done(function() {
            $('#'+id).remove();
          })
          .fail(function() {})
          .always(function() {});
      }
    }

    var createSticky = function createSticky(data) {

      $("<div />", { 
        class: data.type,
        id: data.id,
        keydown: markUnsaved
      })
      .prepend($("<div />", {
        class: "sticky-header"
      })
        .append($("<span />", {
          class: "sticky-status"
        }))
        .append($("<span />", {
          class: "temp-storage",
          text: "이동",
          click: function () { moveSticky($(this).parents("."+data.type).attr("id")); }
        }))
        .append($("<span />", { 
          class: "close-sticky", 
          text: "trash", 
          click: function () { deleteSticky($(this).parents("."+data.type).attr("id")); }
        }))
      )
      .append($("<div />", { 
        html: data.text, 
        contentEditable: "true", 
        class: "sticky-content"
      }))
      .draggable({
        handle: ".sticky-header",
        start: markUnsaved,
        drag: dragposition,
        stop: saveSticky
      })
      .css({
        position: "absolute",
        top: data.top,
        left: data.left
      })
      .css({
          "-webkit-transform":"rotate("+0+"deg)",
          "-moz-transform":"rotate(30deg)",
          "-o-transform":"rotate(30deg)",
          "-ms-transform":"rotate(30deg)",
        })
      .focusout(saveSticky)
      .appendTo($('#board'));
    };

    var deleteSticky = function deleteSticky(id) {

      if (confirm("정말 삭제 할라고?"))
      {
        $.post("<%= post_destroy_board_path(@board) %>", { 'post_id': id })
          .done(function() {
            $("#" + id).fadeOut(200, function () { 
              $(this).remove(); 
            }); 
          })
          .fail(function() {})
          .always(function() {});
      }
    };

    var saveSticky = function saveSticky() {

      var sticky = $(this);
      var obj = {
        id  : sticky.attr("id"),
        top : sticky.css("top"),
        left: sticky.css("left"),
        text: sticky.children(".sticky-content").html(),
        type: sticky.attr("class").split(' ')[0],
        location: '<%= @location %>' 
      };  
      
      $.post("<%= post_create_board_path(@board) %>", { 'post': obj }, function(data) {
        sticky.find(".sticky-status").text("저장완료");
        sticky.attr("id", data);
      });
    };

    var dragposition = function dragposition(event, ui) {
        console.log($.global_var.boardwidth);
        var top_limited = ui.position.top;
        var left_limited = ui.position.left;
        console.log(ui.position.top,ui.position.left);
        if (ui.position.top > $.global_var.boardheight+$.global_var.boardtop-192) {
            top_limited = $.global_var.boardheight+$.global_var.boardtop-192;
        }
        if (ui.position.top < $.global_var.boardtop) {
            top_limited = $.global_var.boardtop;
        }
        if (ui.position.left > $.global_var.boardwidth+$.global_var.boardleft-300) {
            left_limited = $.global_var.boardwidth+$.global_var.boardleft-300;
        }
        if (ui.position.left < $.global_var.boardleft) {
            left_limited = $.global_var.boardleft;
        }
        ui.position.top = top_limited;
        ui.position.left = left_limited;
    }

    var markUnsaved = function markUnsaved() {
      $(this).find(".sticky-status").text("수정 중");
    };

    return {
      open   : openStickies,
      init   : initStickies,
      "new"  : createSticky,
      remove : deleteSticky 
    };

  }();

  STICKIES.open();

</script>
</html>